{% load booking_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice #{{ invoice.invoice_number }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts - Outfit -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-light: #E0E7FF;
            --primary-medium-light: #A5B4FC;
            --primary-medium-dark: #4338CA;
            --primary-dark: #312E81;
            
            --secondary-color: #0CA5E9;
            --secondary-light: #BAE6FD;
            --secondary-medium-light: #38BDF8;
            --secondary-medium-dark: #0369A1;
            --secondary-dark: #075985;
            
            --gray-lightest: #F8FAFC;
            --gray-light: #F1F5F9;
            --gray-medium-light: #E2E8F0;
            --gray-medium: #CBD5E1;
            --gray-medium-dark: #475569;
            --gray-dark: #1E293B;
            --gray-darkest: #0F172A;
            
            --success: #10B981;
            --success-light: #D1FAE5;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --error: #EF4444;
            --error-light: #FEE2E2;
            --info: #3B82F6;
            --info-light: #DBEAFE;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--gray-light);
            color: var(--gray-dark);
            line-height: 1.6;
        }

        .invoice-container {
            max-width: 1000px;
            margin: 2rem auto;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        .invoice-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.75rem 0.75rem 0 0;
            padding: 1.5rem;
        }

        .invoice-body {
            padding: 1.5rem;
        }

        .invoice-footer {
            background-color: var(--gray-light);
            border-radius: 0 0 0.75rem 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .badge-draft { background-color: var(--gray-medium); color: var(--gray-dark); }
        .badge-pending { background-color: var(--warning); color: white; }
        .badge-paid { background-color: var(--success); color: white; }
        .badge-partially_paid { background-color: var(--info); color: white; }
        .badge-overdue { background-color: var(--error); color: white; }
        .badge-cancelled { background-color: var(--gray-dark); color: white; }
        .badge-refunded { background-color: var(--primary-color); color: white; }

        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.75rem 0.75rem 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .card-body {
            padding: 1.5rem;
        }

        .price-tag {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .price-tag .currency {
            font-size: 1.5rem;
            vertical-align: top;
            position: relative;
            top: 0.25rem;
            margin-right: 0.125rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-medium-dark);
            border-color: var(--primary-medium-dark);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            border-color: var(--success);
        }

        .btn-success:hover {
            background-color: #0DA56F;
            border-color: #0DA56F;
        }

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .payment-option {
            border: 1px solid var(--gray-medium-light);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .payment-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .payment-option-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .payment-option-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .payment-option-title {
            font-weight: 600;
            font-size: 1.125rem;
            margin: 0;
        }

        .payment-option-description {
            color: var(--gray-medium-dark);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .invoice-container {
                margin: 1rem;
                border-radius: 0.5rem;
            }
            
            .invoice-header {
                border-radius: 0.5rem 0.5rem 0 0;
                padding: 1rem;
            }
            
            .invoice-body {
                padding: 1rem;
            }
            
            .invoice-footer {
                border-radius: 0 0 0.5rem 0.5rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0">Invoice #{{ invoice.invoice_number }}</h2>
                    <p class="text-white-50 mb-0">{{ invoice.created_at|date:"F j, Y" }}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="status-badge badge-{{ invoice.status }}">
                        {% if invoice.status == 'draft' %}
                            Draft
                        {% elif invoice.status == 'pending' %}
                            Pending
                        {% elif invoice.status == 'paid' %}
                            Paid
                        {% elif invoice.status == 'partially_paid' %}
                            Partially Paid
                        {% elif invoice.status == 'overdue' %}
                            Overdue
                        {% elif invoice.status == 'cancelled' %}
                            Cancelled
                        {% elif invoice.status == 'refunded' %}
                            Refunded
                        {% else %}
                            {{ invoice.status }}
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Invoice Body -->
        <div class="invoice-body">
            <div class="row">
                <!-- Main Invoice Information -->
                <div class="col-lg-8">
                    <!-- Business Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">From</h5>
                        </div>
                        <div class="card-body">
                            <h5>{{ invoice.booking.business.name }}</h5>
                            <p class="mb-0">{{ invoice.booking.business.address }}</p>
                            <p class="mb-0">{{ invoice.booking.business.city }}, {{ invoice.booking.business.state }} {{ invoice.booking.business.zip_code }}</p>
                            <p class="mb-0">{{ invoice.booking.business.phone_number }}</p>
                            <p class="mb-0">{{ invoice.booking.business.email }}</p>
                        </div>
                    </div>

                    <!-- Client Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Bill To</h5>
                        </div>
                        <div class="card-body">
                            <h5>{{ invoice.booking.name }}</h5>
                            <p class="mb-0">{{ invoice.booking.email }}</p>
                            <p class="mb-0">{{ invoice.booking.phone_number }}</p>
                        </div>
                    </div>

                    <!-- Service Details -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Service Details</h5>
                        </div>
                        <div class="card-body">
                            <!-- Service Summary -->
                            <div class="mb-4">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h4>{{ invoice.booking.service_offering.name }}</h4>
                                        {% if invoice.booking.service_offering.description %}
                                            <p class="text-muted">{{ invoice.booking.service_offering.description }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <div class="price-tag">
                                            <span class="currency">$</span>
                                            <span class="amount">{{ total_price }}</span>
                                        </div>
                                        <div class="small text-muted">Total Price</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Service Items List -->
                            {% if service_items %}
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Item</th>
                                                <th class="text-center">Quantity</th>
                                                <th class="text-end">Price</th>
                                                <th class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in service_items %}
                                                <tr>
                                                    <td>
                                                        <div class="fw-bold">{{ item.service_item.name }}</div>
                                                        {% if item.service_item.description %}
                                                            <div class="small text-muted">{{ item.service_item.description }}</div>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">{{ item.quantity }}</td>
                                                    <td class="text-end">${{ item.price_at_booking|divide:item.quantity }}</td>
                                                    <td class="text-end">${{ item.price_at_booking|floatformat:2 }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-light">
                                            <tr>
                                                <th colspan="3" class="text-end">Total</th>
                                                <th class="text-end">${{ total_price }}</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            {% else %}
                                <div class="p-3 rounded bg-info text-white">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Base Price:</span>
                                        <span>${{ invoice.booking.service_offering.price }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total:</span>
                                        <span>${{ total_price }}</span>
                                    </div>
                                </div>
                            {% endif %}

                            {% if invoice.notes %}
                                <div class="mt-4">
                                    <h6 class="fw-bold">Notes</h6>
                                    <p>{{ invoice.notes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Invoice Summary -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Invoice Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Invoice Number:</span>
                                <span class="fw-bold">{{ invoice.invoice_number }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Issue Date:</span>
                                <span>{{ invoice.created_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Due Date:</span>
                                <span>{{ invoice.due_date|date:"M d, Y" }}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Total Amount:</span>
                                <span class="fw-bold">${{ total_price }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Amount Paid:</span>
                                <span>${{ total_paid }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Balance Due:</span>
                                <span class="fw-bold {% if balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                                    ${{ balance_due }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Options -->
                    {% if balance_due > 0 and invoice.status != 'cancelled' %}
                        {% if not request.user.is_authenticated or invoice.booking.business.user != request.user %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Payment Options</h5>
                            </div>
                            <div class="card-body">
                                <div class="payment-options">
                                    <div class="payment-option">
                                        <div class="payment-option-header">
                                            <i class="payment-option-icon fab fa-stripe"></i>
                                            <h6 class="payment-option-title">Payment Options</h6>
                                        </div>
                                        <p class="payment-option-description">Make a secure payment using your credit or debit card</p>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="authorize-toggle">
                                            <label class="form-check-label" for="authorize-toggle">
                                                Authorize payment only (charge after service completion)
                                            </label>
                                        </div>
                                        <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#paymentModal" id="payment-btn">
                                            <i class="fas fa-credit-card me-2"></i> <span id="payment-btn-text">Pay Now</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Invoice Footer -->
        <div class="invoice-footer">
            <p class="mb-0">&copy; {{ invoice.created_at|date:"Y" }} {{ invoice.booking.business.name }}. All rights reserved.</p>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="paymentModalLabel">
                        <span id="paymentModalTitle">Make Payment</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="payment-form-container">
                        <p id="payment-description">
                            Please enter your payment details below to complete your payment.
                        </p>

                        <form id="payment-form">
                            <div class="form-group mb-3">
                                <label for="name" class="form-label">Name on Card</label>
                                <input type="text" id="name" class="form-control" value="{{ invoice.booking.name }}" required>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" class="form-control" value="{{ invoice.booking.email }}" required>
                            </div>
                            
                            <div class="form-group mb-4">
                                <label for="card-element" class="form-label">Credit or Debit Card</label>
                                <div id="card-element" class="form-control p-3"></div>
                                <div id="card-errors" role="alert" class="text-danger mt-2 small"></div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100" id="submit-button">
                                Pay ${{ balance_due }}
                            </button>
                        </form>
                    </div>

                    <div id="payment-processing" style="display: none; text-align: center; padding: 2rem;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Processing your payment. Please do not close this page...</p>
                    </div>

                    <div id="payment-success" style="display: none; text-align: center; padding: 2rem;">
                        <div class="text-success mb-3">
                            <i class="fas fa-check-circle fa-4x"></i>
                        </div>
                        <h3 id="success-title">Payment Successful!</h3>
                        <p id="success-message">
                            Your payment has been processed successfully.
                        </p>
                        <button type="button" class="btn btn-primary mt-3" data-bs-dismiss="modal">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Payment Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Stripe with the public key
            const stripe = Stripe('{{ stripe_public_key }}');
            const elements = stripe.elements();
            
            // Create card element
            const cardElement = elements.create('card', {
                style: {
                    base: {
                        color: '#32325d',
                        fontFamily: '"Outfit", sans-serif',
                        fontSmoothing: 'antialiased',
                        fontSize: '16px',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#EF4444',
                        iconColor: '#EF4444'
                    }
                }
            });
            
            // Mount the card element
            cardElement.mount('#card-element');
            
            // Handle real-time validation errors
            cardElement.on('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
            
            // Set up payment type buttons
            const paymentBtn = document.getElementById('payment-btn');
            const authorizeToggle = document.getElementById('authorize-toggle');
            const paymentBtnText = document.getElementById('payment-btn-text');
            const paymentForm = document.getElementById('payment-form');
            const submitButton = document.getElementById('submit-button');
            const processingDiv = document.getElementById('payment-processing');
            const formContainer = document.getElementById('payment-form-container');
            const successDiv = document.getElementById('payment-success');
            const modalTitle = document.getElementById('paymentModalTitle');
            const paymentDescription = document.getElementById('payment-description');
            const successTitle = document.getElementById('success-title');
            const successMessage = document.getElementById('success-message');
            
            let paymentType = 'instant';
            let clientSecret = '';
            let customerId = '';
            
            // Handle authorize toggle change
            if (authorizeToggle) {
                authorizeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        paymentType = 'authorize';
                        paymentBtnText.textContent = 'Authorize Payment';
                    } else {
                        paymentType = 'instant';
                        paymentBtnText.textContent = 'Pay Now';
                    }
                });
            }
            
            if (paymentBtn) {
                paymentBtn.addEventListener('click', function() {
                    // Clear previous errors
                    document.getElementById('card-errors').textContent = '';
                    
                    if (paymentType === 'instant') {
                        modalTitle.textContent = 'Make Payment';
                        paymentDescription.textContent = 'Please enter your payment details below to complete your payment.';
                        submitButton.textContent = 'Pay ${{ balance_due }}';
                        
                        // Get client secret for payment intent
                        fetch('{% url "invoices:get_payment_intent" invoice.id %}')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to create payment intent');
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                clientSecret = data.client_secret;
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                document.getElementById('card-errors').textContent = error.message || 'Failed to create payment intent. Please try again.';
                            });
                    } else {
                        modalTitle.textContent = 'Authorize Payment';
                        paymentDescription.textContent = 'Please enter your payment details below to authorize a payment for later. Your card will not be charged until the service is completed.';
                        submitButton.textContent = 'Authorize Payment';
                        
                        // Get client secret for setup intent
                        fetch('{% url "invoices:get_setup_intent" invoice.id %}')
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to create setup intent');
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                clientSecret = data.client_secret;
                                customerId = data.customer_id;
                                console.log('Setup intent created with customer ID:', customerId);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                document.getElementById('card-errors').textContent = error.message || 'Failed to create setup intent. Please try again.';
                            });
                    }
                });
            }
            
            // Handle form submission
            paymentForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Clear previous errors
                document.getElementById('card-errors').textContent = '';
                
                // Check if client secret is available
                if (!clientSecret) {
                    document.getElementById('card-errors').textContent = 'Payment setup is not complete. Please try again.';
                    return;
                }
                
                // Disable the submit button to prevent multiple submissions
                submitButton.disabled = true;
                
                // Show processing state
                formContainer.style.display = 'none';
                processingDiv.style.display = 'block';
                
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                
                // Create billing details object
                const billingDetails = {
                    name: name,
                    email: email
                };
                
                if (paymentType === 'instant') {
                    // Handle payment intent confirmation
                    stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: cardElement,
                            billing_details: billingDetails
                        }
                    }).then(function(result) {
                        if (result.error) {
                            // Show error to customer
                            handlePaymentError(result.error.message);
                        } else {
                            // Payment successful - Create payment record on server
                            fetch('{% url "invoices:get_payment_intent" invoice.id %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({
                                    payment_intent_id: result.paymentIntent.id,
                                    amount: {{ balance_due|floatformat:2 }}
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(data => {
                                        throw new Error(data.error || 'Failed to record payment');
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                
                                // Payment record created successfully
                                showSuccessMessage('Payment Successful!', 'Your payment has been processed successfully.');
                                
                                // Reload the page after 3 seconds to show updated payment status
                                setTimeout(function() {
                                    window.location.reload();
                                }, 3000);
                            })
                            .catch(error => {
                                console.error('Error creating payment record:', error);
                                
                                // Show a warning that payment was processed but recording failed
                                showSuccessMessage(
                                    'Payment Processed', 
                                    'Your payment was processed by Stripe, but we encountered an issue recording it in our system. Please contact support if your payment does not appear shortly.'
                                );
                                
                                setTimeout(function() {
                                    window.location.reload();
                                }, 5000);
                            });
                        }
                    });
                } else {
                    // Handle setup intent confirmation
                    stripe.confirmCardSetup(clientSecret, {
                        payment_method: {
                            card: cardElement,
                            billing_details: billingDetails
                        }
                    }).then(function(result) {
                        if (result.error) {
                            // Show error to customer
                            handlePaymentError(result.error.message);
                        } else {
                            console.log('Setup intent confirmed:', result.setupIntent);
                            
                            // Setup successful - Update invoice on server
                            fetch('{% url "invoices:get_setup_intent" invoice.id %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCsrfToken()
                                },
                                body: JSON.stringify({
                                    setup_intent_id: result.setupIntent.id,
                                    payment_method_id: result.setupIntent.payment_method
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(data => {
                                        throw new Error(data.error || 'Failed to update invoice');
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    throw new Error(data.error);
                                }
                                
                                // Invoice updated successfully
                                showSuccessMessage(
                                    'Payment Method Authorized!', 
                                    'Your payment method has been saved and authorized successfully. Your card will not be charged until the service is completed.'
                                );
                                
                                // Reload the page after 3 seconds to show updated status
                                setTimeout(function() {
                                    window.location.reload();
                                }, 3000);
                            })
                            .catch(error => {
                                console.error('Error updating invoice:', error);
                                handlePaymentError(error.message || 'Failed to update invoice. Please try again or contact support.');
                            });
                        }
                    });
                }
            });
            
            // Helper function to handle payment errors
            function handlePaymentError(errorMessage) {
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = errorMessage || 'An error occurred during payment processing';
                
                // Reset UI
                submitButton.disabled = false;
                formContainer.style.display = 'block';
                processingDiv.style.display = 'none';
                successDiv.style.display = 'none';
            }
            
            // Helper function to show success message
            function showSuccessMessage(title, message) {
                processingDiv.style.display = 'none';
                successDiv.style.display = 'block';
                successTitle.textContent = title;
                successMessage.textContent = message;
            }
            
            // Reset modal when it's hidden
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.addEventListener('hidden.bs.modal', function() {
                submitButton.disabled = false;
                formContainer.style.display = 'block';
                processingDiv.style.display = 'none';
                successDiv.style.display = 'none';
                document.getElementById('card-errors').textContent = '';
            });
        });
        
        // Function to get CSRF token from cookies
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
